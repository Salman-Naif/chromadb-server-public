{% extends "base.html" %}

{% block title %}التحليلات{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">
            <i class="fas fa-chart-bar"></i>
            التحليلات والتقارير
        </h1>
        <p class="page-subtitle">إحصائيات الاستخدام وتحليلات الأداء</p>
    </div>
    <div style="display: flex; gap: 10px;">
        <select id="periodFilter" class="form-control" style="width: auto;" onchange="updateCharts()">
            <option value="7">آخر 7 أيام</option>
            <option value="30" selected>آخر 30 يوم</option>
            <option value="90">آخر 3 أشهر</option>
        </select>
        <button class="btn btn-secondary" onclick="exportReport()">
            <i class="fas fa-file-pdf"></i>
            تصدير PDF
        </button>
    </div>
</div>

<!-- Usage Stats -->
<div class="stats-grid fade-in">
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="fas fa-search"></i>
        </div>
        <div>
            <div class="stat-value">{{ analytics.queries.total }}</div>
            <div class="stat-label">إجمالي الاستعلامات</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon success">
            <i class="fas fa-chart-line"></i>
        </div>
        <div>
            <div class="stat-value">{{ analytics.queries.avg_per_day }}</div>
            <div class="stat-label">متوسط يومي</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon warning">
            <i class="fas fa-clock"></i>
        </div>
        <div>
            <div class="stat-value">{{ analytics.performance.avg_retrieval_time }} ms</div>
            <div class="stat-label">متوسط وقت الاستجابة</div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon info">
            <i class="fas fa-percentage"></i>
        </div>
        <div>
            <div class="stat-value">{{ analytics.queries.success_rate }}%</div>
            <div class="stat-label">نسبة النجاح</div>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px;">
    <!-- Queries Chart -->
    <div class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-line"></i>
                الاستعلامات خلال الفترة
            </h3>
        </div>
        <div style="height: 250px; position: relative;">
            <canvas id="queriesChart"></canvas>
        </div>
    </div>
    
    <!-- Document Types -->
    <div class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-pie"></i>
                توزيع أنواع الملفات
            </h3>
        </div>
        <div style="height: 250px; position: relative;">
            <canvas id="typesChart"></canvas>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 20px;">
    <!-- Most Accessed Documents -->
    <div class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-fire"></i>
                الملفات الأكثر استخداماً
            </h3>
        </div>
        
        {% if analytics.documents.most_accessed %}
        <div class="ranking-list">
            {% for doc in analytics.documents.most_accessed %}
            <div class="ranking-item">
                <div class="ranking-number">{{ loop.index }}</div>
                <div class="ranking-info">
                    <div class="ranking-name">{{ doc.filename[:35] }}{% if doc.filename|length > 35 %}...{% endif %}</div>
                    <div class="ranking-meta">{{ doc.query_count }} استعلام</div>
                </div>
                <div class="ranking-bar">
                    <div class="ranking-bar-fill" style="width: {{ (doc.query_count / analytics.documents.most_accessed[0].query_count * 100)|int }}%"></div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <p>لا توجد بيانات</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Peak Hours -->
    <div class="card fade-in">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-clock"></i>
                ساعات الذروة
            </h3>
        </div>
        <div style="height: 200px; position: relative;">
            <canvas id="hoursChart"></canvas>
        </div>
    </div>
</div>

<!-- Language Distribution -->
<div class="card fade-in" style="margin-top: 20px;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-language"></i>
            توزيع اللغات
        </h3>
    </div>
    
    <div class="lang-distribution">
        <div class="lang-item">
            <div class="lang-icon ar">
                <i class="fas fa-font"></i>
            </div>
            <div class="lang-info">
                <div class="lang-name">عربي</div>
                <div class="lang-count">{{ analytics.documents.language_dist.ar }} مستند</div>
            </div>
            <div class="lang-bar">
                <div class="lang-bar-fill ar" style="width: {{ analytics.documents.language_dist.ar_percent }}%"></div>
            </div>
            <div class="lang-percent">{{ analytics.documents.language_dist.ar_percent }}%</div>
        </div>
        
        <div class="lang-item">
            <div class="lang-icon en">
                <i class="fas fa-font"></i>
            </div>
            <div class="lang-info">
                <div class="lang-name">إنجليزي</div>
                <div class="lang-count">{{ analytics.documents.language_dist.en }} مستند</div>
            </div>
            <div class="lang-bar">
                <div class="lang-bar-fill en" style="width: {{ analytics.documents.language_dist.en_percent }}%"></div>
            </div>
            <div class="lang-percent">{{ analytics.documents.language_dist.en_percent }}%</div>
        </div>
        
        <div class="lang-item">
            <div class="lang-icon mixed">
                <i class="fas fa-font"></i>
            </div>
            <div class="lang-info">
                <div class="lang-name">مختلط</div>
                <div class="lang-count">{{ analytics.documents.language_dist.mixed }} مستند</div>
            </div>
            <div class="lang-bar">
                <div class="lang-bar-fill mixed" style="width: {{ analytics.documents.language_dist.mixed_percent }}%"></div>
            </div>
            <div class="lang-percent">{{ analytics.documents.language_dist.mixed_percent }}%</div>
        </div>
    </div>
</div>

{% if current_user.role == 'system_manager' %}
<!-- User Analytics -->
<div class="card fade-in" style="margin-top: 20px;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-users"></i>
            إحصائيات المستخدمين
        </h3>
    </div>
    
    {% if analytics.users %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>المستخدم</th>
                    <th>الملفات المرفوعة</th>
                    <th>آخر نشاط</th>
                    <th>الحالة</th>
                </tr>
            </thead>
            <tbody>
                {% for user in analytics.users %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="user-avatar-mini">{{ user.name[0] }}</div>
                            <span>{{ user.name }}</span>
                        </div>
                    </td>
                    <td>{{ user.uploads }}</td>
                    <td>{{ user.last_activity }}</td>
                    <td>
                        <span class="badge badge-{{ 'success' if user.is_active else 'error' }}">
                            {{ 'نشط' if user.is_active else 'غير نشط' }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
        <p>لا توجد بيانات</p>
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .ranking-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .ranking-item {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .ranking-number {
        width: 30px;
        height: 30px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9em;
    }
    
    .ranking-info {
        flex: 1;
        min-width: 0;
    }
    
    .ranking-name {
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .ranking-meta {
        font-size: 0.8em;
        color: var(--text-secondary);
    }
    
    .ranking-bar {
        width: 80px;
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
    }
    
    .ranking-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }
    
    .lang-distribution {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .lang-item {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .lang-icon {
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .lang-icon.ar {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }
    
    .lang-icon.en {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
    }
    
    .lang-icon.mixed {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
    }
    
    .lang-info {
        min-width: 120px;
    }
    
    .lang-name {
        font-weight: 600;
    }
    
    .lang-count {
        font-size: 0.85em;
        color: var(--text-secondary);
    }
    
    .lang-bar {
        flex: 1;
        height: 10px;
        background: var(--border-color);
        border-radius: 5px;
        overflow: hidden;
    }
    
    .lang-bar-fill {
        height: 100%;
    }
    
    .lang-bar-fill.ar {
        background: #22c55e;
    }
    
    .lang-bar-fill.en {
        background: #3b82f6;
    }
    
    .lang-bar-fill.mixed {
        background: #f59e0b;
    }
    
    .lang-percent {
        min-width: 50px;
        text-align: left;
        font-weight: 600;
    }
    
    .user-avatar-mini {
        width: 30px;
        height: 30px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.85em;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Charts data from server
    const queriesData = {{ analytics.queries.chart_data|tojson|safe if analytics.queries.chart_data else '[]' }};
    const typesData = {{ analytics.documents.types|tojson|safe if analytics.documents.types else '{}' }};
    const hoursData = {{ analytics.queries.hours|tojson|safe if analytics.queries.hours else '[]' }};
    
    // Queries Line Chart
    const queriesCtx = document.getElementById('queriesChart').getContext('2d');
    new Chart(queriesCtx, {
        type: 'line',
        data: {
            labels: queriesData.map(d => d.date),
            datasets: [{
                label: 'الاستعلامات',
                data: queriesData.map(d => d.count),
                borderColor: '#1a5f7a',
                backgroundColor: 'rgba(26, 95, 122, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#94a3b8'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#94a3b8'
                    }
                }
            }
        }
    });
    
    // Types Pie Chart
    const typesCtx = document.getElementById('typesChart').getContext('2d');
    new Chart(typesCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(typesData),
            datasets: [{
                data: Object.values(typesData),
                backgroundColor: [
                    '#ef4444',
                    '#3b82f6',
                    '#f59e0b',
                    '#22c55e'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#94a3b8',
                        padding: 20
                    }
                }
            }
        }
    });
    
    // Hours Bar Chart
    const hoursCtx = document.getElementById('hoursChart').getContext('2d');
    new Chart(hoursCtx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: 'الاستعلامات',
                data: hoursData,
                backgroundColor: 'rgba(26, 95, 122, 0.6)',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#94a3b8'
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#94a3b8',
                        maxRotation: 0
                    }
                }
            }
        }
    });
    
    function updateCharts() {
        // In production, this would fetch new data based on period
        location.reload();
    }
    
    function exportReport() {
        alert('سيتم تنفيذ هذه الميزة قريباً');
    }
</script>
{% endblock %}
